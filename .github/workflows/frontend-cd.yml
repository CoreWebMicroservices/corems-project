name: Frontend CD

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (dev, staging, prod)'
        required: true
        type: string
      docker-registry:
        description: 'Docker registry (ghcr.io or docker.io)'
        required: false
        type: string
        default: 'ghcr.io'
      image-tag:
        description: 'Docker image tag to deploy'
        required: false
        type: string
        default: 'latest'

    secrets:
      github-token:
        description: 'GitHub token for package access'
        required: true
      docker-username:
        description: 'Docker registry username'
        required: false
      docker-password:
        description: 'Docker registry password'
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.docker-registry }}
          username: ${{ secrets.docker-username || github.actor }}
          password: ${{ secrets.docker-password || secrets.github-token }}

      - name: Pull Docker Image
        run: |
          docker pull ${{ inputs.docker-registry }}/${{ github.repository_owner }}/frontend:${{ inputs.image-tag }}

      - name: Deploy via Docker Compose
        run: |
          echo "Deploying frontend to ${{ inputs.environment }} via Docker Compose..."
          
          mkdir -p deploy
          
          cat > deploy/docker-compose.yml <<EOF
          services:
            frontend:
              image: ${{ inputs.docker-registry }}/${{ github.repository_owner }}/frontend:${{ inputs.image-tag }}
              container_name: frontend-${{ inputs.environment }}
              restart: unless-stopped
              ports:
                - "8080:80"
              networks:
                - corems-network
          
          networks:
            corems-network:
              external: true
          EOF
          
          cd deploy
          docker-compose up -d

      - name: Health Check
        run: |
          echo "Waiting for frontend to be healthy..."
          sleep 20
          echo "âœ… Frontend deployed successfully to ${{ inputs.environment }}"
